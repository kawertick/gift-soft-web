<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftSoft</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 70px;
        }

        /* Шапка */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px 0;
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #8B5FBF, #6A0DAD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Контент */
        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        /* Нижнее меню */
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 15px;
            border-top: 1px solid #333;
            gap: 10px;
        }

        .menu-item {
            text-align: center;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .menu-item.active {
            color: #8B5FBF;
        }

        .menu-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        /* Кейсы */
        .cases-grid {
            display: grid;
            gap: 20px;
        }

        .case-item {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .case-item:hover {
            transform: translateY(-5px);
            border-color: #8B5FBF;
        }

        .case-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .case-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #8B5FBF;
        }

        .case-price {
            color: #ffd700;
            font-weight: bold;
            font-size: 16px;
        }

        /* Модальное окно кейса */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #8B5FBF;
            max-width: 350px;
            width: 100%;
            text-align: center;
        }

        .modal-case-icon {
            font-size: 70px;
            margin-bottom: 20px;
        }

        .modal-case-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #8B5FBF;
        }

        .modal-case-price {
            color: #ffd700;
            font-size: 18px;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: grid;
            gap: 12px;
        }

        /* Дроп кейса */
        .drop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .drop-item {
            background: #252525;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border: 1px solid #333;
        }

        .drop-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .drop-name {
            font-size: 10px;
            color: #ccc;
        }

        /* Кнопки */
        .purple-button {
            background: linear-gradient(45deg, #8B5FBF, #6A0DAD);
            border: none;
            padding: 15px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 16px;
        }

        .purple-button:hover {
            transform: scale(1.05);
        }

        .purple-button:active {
            transform: scale(0.95);
        }

        .outline-button {
            background: transparent;
            border: 2px solid #8B5FBF;
            padding: 15px;
            border-radius: 12px;
            color: #8B5FBF;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .outline-button:hover {
            background: #8B5FBF;
            color: white;
        }

        /* Рулетка */
        .roulette-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.98);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .roulette-slots {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            height: 100px;
            overflow: hidden;
            position: relative;
        }

        .roulette-track {
            display: flex;
            flex-direction: column;
            gap: 10px;
            animation: scroll 3s ease-out forwards;
        }

        @keyframes scroll {
            0% { transform: translateY(-1000%); }
            100% { transform: translateY(0); }
        }

        .roulette-item {
            width: 80px;
            height: 80px;
            background: #252525;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .roulette-result {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #8B5FBF;
        }

        .reward-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }

        /* Профиль */
        .profile-info {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #8B5FBF, #6A0DAD);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #252525;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            color: #8B5FBF;
            font-weight: bold;
            font-size: 18px;
        }

        .balance-info {
            color: #ffd700;
            font-weight: bold;
            margin: 10px 0;
        }

        .promo-section {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        .promo-title {
            text-align: center;
            margin-bottom: 15px;
            color: #8B5FBF;
            font-weight: bold;
        }

        .promo-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .promo-input input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #333;
            background: #252525;
            color: white;
            outline: none;
        }

        .inventory-section {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
        }

        .inventory-title {
            text-align: center;
            margin-bottom: 15px;
            color: #8B5FBF;
            font-weight: bold;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .nft-item {
            background: #252525;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #333;
        }

        .nft-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .nft-name {
            font-size: 12px;
            color: #ccc;
        }

        .empty-inventory {
            text-align: center;
            color: #888;
            padding: 30px;
            grid-column: 1 / -1;
        }

        /* Блокировка кнопок после нажатия */
        .button-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка -->
        <div class="header">
            <div class="app-title">GiftSoft</div>
        </div>

        <!-- Кейсы -->
        <div id="cases-content" class="content active">
            <div class="cases-grid">
                <div class="case-item" onclick="openCaseModal(1)">
                    <div class="case-icon">🎁</div>
                    <div class="case-name">Кейс Бомж</div>
                    <div class="case-price"><span id="case-price-1">100</span> 🎫</div>
                </div>
            </div>
        </div>

        <!-- Апгрейд -->
        <div id="upgrade-content" class="content">
            <div style="text-align: center; padding: 50px 20px; color: #888;">
                <div style="font-size: 48px; margin-bottom: 15px;">⚡</div>
                <div style="color: #8B5FBF;">Раздел в разработке</div>
            </div>
        </div>

        <!-- Профиль -->
        <div id="profile-content" class="content">
            <div class="profile-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-name" id="user-name">Username</div>
                <div class="balance-info">Баланс: <span id="user-balance">1000</span> 🎫</div>
            </div>

            <div class="user-stats">
                <div class="stat-item">
                    <div>Открыто кейсов</div>
                    <div class="stat-value" id="opened-cases">0</div>
                </div>
                <div class="stat-item">
                    <div>NFT получено</div>
                    <div class="stat-value" id="nft-count">0</div>
                </div>
            </div>

            <div class="promo-section">
                <div class="promo-title">🎟️ Активация промокода</div>
                <div class="promo-input">
                    <input type="text" placeholder="Введите промокод" id="promo-code">
                    <button class="purple-button" onclick="activatePromo()">OK</button>
                </div>
            </div>

            <div class="inventory-section">
                <div class="inventory-title">🎒 Мой инвентарь NFT</div>
                <div class="inventory-grid" id="inventory-grid">
                    <div class="empty-inventory">
                        <div style="font-size: 48px; margin-bottom: 15px;">📦</div>
                        <div style="color: #888;">Инвентарь пуст</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Нижнее меню -->
    <div class="bottom-menu">
        <div class="menu-item active" onclick="showTab('cases')">
            <div class="menu-icon">🎁</div>
            <div>Кейсы</div>
        </div>
        <div class="menu-item" onclick="showTab('upgrade')">
            <div class="menu-icon">⚡</div>
            <div>Апгрейд</div>
        </div>
        <div class="menu-item" onclick="showTab('profile')">
            <div class="menu-icon">👤</div>
            <div>Профиль</div>
        </div>
    </div>

    <!-- Модальное окно кейса -->
    <div class="modal" id="case-modal">
        <div class="modal-content">
            <div class="modal-case-icon">🎁</div>
            <div class="modal-case-name">Кейс Бомж</div>
            <div class="modal-case-price"><span id="modal-case-price">100</span> 🎫</div>
            
            <div class="drop-grid" id="case-drop">
                <!-- Дроп будет заполнен JavaScript -->
            </div>

            <div class="modal-buttons">
                <button class="purple-button" onclick="openRoulette()">Открыть кейс</button>
                <button class="outline-button" onclick="closeModal()">Назад</button>
            </div>
        </div>
    </div>

    <!-- Рулетка -->
    <div class="roulette-container" id="roulette">
        <div class="roulette-slots">
            <div class="roulette-track" id="roulette-track">
                <!-- Рулетка будет заполнена JavaScript -->
            </div>
        </div>
        <div class="roulette-result" id="roulette-result">Открываем кейс...</div>
        <div class="reward-buttons" id="reward-buttons" style="display: none;">
            <button class="outline-button" id="exchange-btn" onclick="exchangeReward()">Обменять на <span id="exchange-price">0</span> 🎫</button>
            <button class="purple-button" id="keep-btn" onclick="keepReward()">Оставить в инвентаре</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        
        // Инициализация Telegram Web App
        tg.expand();
        tg.enableClosingConfirmation();

        // Данные пользователя
        let userData = {
            balance: 1000,
            openedCases: 0,
            inventory: []
        };

        // ПРИВЯЗКА К TELEGRAM
        function initUser() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                document.getElementById('user-name').textContent = user.first_name || 'User';
                if (user.first_name) {
                    document.getElementById('user-avatar').textContent = user.first_name[0].toUpperCase();
                }
                document.getElementById('user-balance').textContent = userData.balance;
            } else {
                // Fallback для тестирования
                document.getElementById('user-name').textContent = 'Telegram User';
                document.getElementById('user-avatar').textContent = 'T';
            }
        }

        // Данные кейса с индивидуальными ценами обмена
        const cases = {
            1: {
                name: "Кейс Бомж",
                icon: "🎁",
                price: 100,
                drops: [
                    { 
                        id: "sticker_pack_1", 
                        icon: "😊", 
                        name: "Набор стикеров", 
                        chance: 40,
                        exchangePrice: 30 // Индивидуальная цена обмена
                    },
                    { 
                        id: "emoji_pack", 
                        icon: "🎨", 
                        name: "Набор эмодзи", 
                        chance: 30,
                        exchangePrice: 40
                    },
                    { 
                        id: "premium_stickers", 
                        icon: "⭐", 
                        name: "Премиум стикеры", 
                        chance: 20,
                        exchangePrice: 60
                    },
                    { 
                        id: "theme_pack", 
                        icon: "🎨", 
                        name: "Тема оформления", 
                        chance: 10,
                        exchangePrice: 80
                    }
                ]
            }
        };

        // Текущий выигрыш
        let currentReward = null;
        let buttonsLocked = false;

        // Блокировка кнопок
        function lockButtons() {
            buttonsLocked = true;
            document.getElementById('exchange-btn').classList.add('button-disabled');
            document.getElementById('keep-btn').classList.add('button-disabled');
        }

        // Открыть модальное окно кейса
        function openCaseModal(caseId) {
            const caseData = cases[caseId];
            const dropGrid = document.getElementById('case-drop');
            dropGrid.innerHTML = '';
            
            caseData.drops.forEach(drop => {
                dropGrid.innerHTML += `
                    <div class="drop-item">
                        <div class="drop-icon">${drop.icon}</div>
                        <div class="drop-name">${drop.name}</div>
                        <div style="font-size: 9px; color: #888;">${drop.chance}%</div>
                    </div>
                `;
            });

            document.getElementById('modal-case-price').textContent = caseData.price;
            document.getElementById('case-modal').style.display = 'flex';
        }

        // Закрыть модальное окно
        function closeModal() {
            document.getElementById('case-modal').style.display = 'none';
        }

        // Открыть рулетку
        function openRoulette() {
            const caseData = cases[1];
            
            // Проверяем баланс
            if (userData.balance < caseData.price) {
                tg.showPopup({
                    title: "❌ Недостаточно средств",
                    message: "Пополните баланс для открытия кейса",
                    buttons: [{type: "ok"}]
                });
                return;
            }

            // Списываем валюту
            userData.balance -= caseData.price;
            document.getElementById('user-balance').textContent = userData.balance;
            
            document.getElementById('roulette').style.display = 'flex';
            spinRoulette();
        }

        // Анимация рулетки - ФИКС: выпадает только 1 подарок
        function spinRoulette() {
            const caseData = cases[1];
            const track = document.getElementById('roulette-track');
            const resultText = document.getElementById('roulette-result');
            
            // Случайный выбор приза
            const random = Math.random() * 100;
            let accumulatedChance = 0;
            let selectedDrop = null;

            for (const drop of caseData.drops) {
                accumulatedChance += drop.chance;
                if (random <= accumulatedChance) {
                    selectedDrop = drop;
                    break;
                }
            }

            currentReward = selectedDrop;
            buttonsLocked = false;

            // ФИКС: Заполняем рулетку только выигрышным предметом
            track.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                // Создаем промежуточные предметы для анимации
                const randomIcon = "❓";
                track.innerHTML += `<div class="roulette-item">${randomIcon}</div>`;
            }
            // Добавляем выигрышный предмет в конец
            track.innerHTML += `<div class="roulette-item">${selectedDrop.icon}</div>`;

            // Запускаем анимацию
            track.style.animation = 'none';
            setTimeout(() => {
                track.style.animation = 'scroll 3s ease-out forwards';
            }, 10);

            // Показываем результат и цену обмена
            setTimeout(() => {
                resultText.textContent = `Вы выиграли: ${selectedDrop.name}!`;
                document.getElementById('exchange-price').textContent = selectedDrop.exchangePrice;
                document.getElementById('reward-buttons').style.display = 'grid';
            }, 3000);
        }

        // Обменять награду на валюту
        function exchangeReward() {
            if (buttonsLocked) return;
            lockButtons();
            
            userData.balance += currentReward.exchangePrice;
            document.getElementById('user-balance').textContent = userData.balance;
            
            tg.showPopup({
                title: "🎉 Обменено!",
                message: `Вы получили ${currentReward.exchangePrice} 🎫 за подарок`,
                buttons: [{type: "ok"}]
            });
            
            // ФИКС: Закрываем меню сразу
            setTimeout(() => {
                closeRoulette();
                closeModal();
            }, 1500);
        }

        // Оставить награду в инвентаре
        function keepReward() {
            if (buttonsLocked) return;
            lockButtons();
            
            if (!userData.inventory.includes(currentReward.id)) {
                userData.inventory.push(currentReward.id);
                userData.openedCases++;
                
                document.getElementById('opened-cases').textContent = userData.openedCases;
                document.getElementById('nft-count').textContent = userData.inventory.length;
                updateInventory();
                
                tg.showPopup({
                    title: "🎉 Добавлено в инвентарь!",
                    message: `${currentReward.name} сохранен`,
                    buttons: [{type: "ok"}]
                });
            }
            
            // ФИКС: Закрываем меню сразу
            setTimeout(() => {
                closeRoulette();
                closeModal();
            }, 1500);
        }

        // Закрыть рулетку
        function closeRoulette() {
            document.getElementById('roulette').style.display = 'none';
            document.getElementById('reward-buttons').style.display = 'none';
            document.getElementById('roulette-result').textContent = "Открываем кейс...";
        }

        // Обновление инвентаря
        function updateInventory() {
            const inventoryGrid = document.getElementById('inventory-grid');
            
            if (userData.inventory.length === 0) {
                inventoryGrid.innerHTML = `
                    <div class="empty-inventory">
                        <div style="font-size: 48px; margin-bottom: 15px;">📦</div>
                        <div style="color: #888;">Инвентарь пуст</div>
                    </div>
                `;
                return;
            }

            inventoryGrid.innerHTML = '';
            userData.inventory.forEach(nftId => {
                const nft = cases[1].drops.find(item => item.id === nftId);
                if (nft) {
                    inventoryGrid.innerHTML += `
                        <div class="nft-item">
                            <div class="nft-icon">${nft.icon}</div>
                            <div class="nft-name">${nft.name}</div>
                        </div>
                    `;
                }
            });
        }

        // Активация промокода
        function activatePromo() {
            const promoCode = document.getElementById('promo-code').value;
            if (!promoCode) return;

            const rewards = {
                'WELCOME100': { balance: 100 },
                'START2024': { balance: 200 }
            };

            if (rewards[promoCode]) {
                userData.balance += rewards[promoCode].balance;
                document.getElementById('user-balance').textContent = userData.balance;
                
                tg.showPopup({
                    title: "🎉 Промокод активирован!",
                    message: `Вы получили ${rewards[promoCode].balance} 🎫`,
                    buttons: [{type: "ok"}]
                });
            }

            document.getElementById('promo-code').value = '';
        }

        // Переключение разделов
        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(tabName + '-content').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            initUser();
            updateInventory();
        });
    </script>
</body>
</html>